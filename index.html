<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Glass Target â€“ Web PoC</title>
<style>
  :root{
    --bg: #b40000;    /* rot idle */
    --ok: #0a7a0a;    /* grÃ¼n erkannt */
    --ring: #ffffffcc;
    --text: #fff;
    --target-mm: 65;  /* Standard: 65 mm */
  }
  html,body {height:100%;margin:0;background:var(--bg);color:var(--text);font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap {min-height:100%;display:flex;flex-direction:column}
  header{display:flex;gap:.5rem;align-items:center;justify-content:center;padding:.75rem 1rem}
  header .cta{padding:.6rem 1rem;border-radius:999px;background:#00000040;backdrop-filter:blur(6px)}
  header small{opacity:.85;font-weight:500}
  main{flex:1;display:grid;place-items:center;padding:24px}
  .stage{position:relative;display:grid;place-items:center;max-width:560px;width:100%;aspect-ratio:9/16}
  .hint{
    position:absolute;top:10%;left:50%;transform:translateX(-50%);
    text-align:center;max-width:86%;opacity:.95
  }
  .hint .title{font-size:clamp(18px,4.5vw,28px)}
  .hint .sub{font-weight:500;opacity:.85;margin-top:.35rem}
  .target{
    position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;
  }
  /* Zielkreis: wir rechnen PixelgrÃ¶ÃŸe aus JS, animieren hier nur Stil */
  .ring{
    position:relative;border-radius:999px;border:3px dashed var(--ring);
    box-shadow:0 0 20px #ffffff40, inset 0 0 18px #ffffff26;
    animation:pulse 1.6s ease-in-out infinite;
    backdrop-filter:blur(2px);
  }
  .ring::before, .ring::after{
    content:"";position:absolute;border-radius:999px;inset:-10px;
    border:2px solid #ffffff1f;animation:pulse 2.2s ease-in-out infinite;
  }
  .ring::after{inset:-22px;opacity:.7;animation-duration:2.8s}
  @keyframes pulse{
    0%,100%{transform:scale(1);opacity:1}
    50%{transform:scale(1.04);opacity:.95}
  }
  .arrow{
    position:absolute;top:calc(50% - 140px);left:50%;transform:translateX(-50%);
    width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:16px solid var(--ring);
    filter:drop-shadow(0 2px 4px #00000050);animation:bounce 1.2s ease-in-out infinite;
  }
  @keyframes bounce{0%,100%{transform:translate(-50%,0)}50%{transform:translate(-50%,6px)}}

  .status{
    position:absolute;bottom:10%;left:50%;transform:translateX(-50%);
    padding:.6rem 1rem;border-radius:12px;background:#00000033;backdrop-filter:blur(6px);
    font-weight:700;letter-spacing:.2px
  }
  .controls{
    position:absolute;bottom:2%;left:50%;transform:translateX(-50%);
    display:flex;gap:.6rem;align-items:center;background:#00000033;
    padding:.55rem .8rem;border-radius:12px;backdrop-filter:blur(6px);font-weight:600
  }
  .controls input[type="range"]{width:min(56vw,360px)}
  .tag{opacity:.85;padding:.15rem .5rem;border-radius:.5rem;background:#ffffff22;margin-left:.25rem}
  .go{padding:.5rem .9rem;border-radius:.7rem;background:#ffffff22;border:1px solid #ffffff45;color:#fff}
  .ok{background:#ffffff33}
  /* erkannt-Zustand */
  .detected body, .detected {background:var(--ok)}
  .flash{animation:flash .4s ease-out}
  @keyframes flash{0%{filter:brightness(1.6)}100%{filter:brightness(1)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="cta">ðŸ‘‰ <strong>Stell dein Glas hier ab</strong> â€“ wir zeigen dir, obâ€™s erkannt wird.</div>
  </header>

  <main>
    <div class="stage" id="stage">
      <div class="hint">
        <div class="title">ZIELKREIS</div>
        <div class="sub">Platziere den Glasboden in den Kreis. Tippe <em>Start</em> und stell das Glas hÃ¶rbar ab.</div>
      </div>

      <div class="target">
        <div class="arrow" aria-hidden="true"></div>
        <div class="ring" id="ring" aria-label="Zielkreis"></div>
      </div>

      <div class="status" id="status">Warte auf Startâ€¦</div>

      <div class="controls">
        <button id="btn" class="go">Start</button>
        <label for="size">Durchmesser:
          <span class="tag"><span id="mmOut">65</span> mm</span>
        </label>
        <input id="size" type="range" min="45" max="90" value="65" step="1" />
      </div>
    </div>
  </main>
</div>

<script>
  // Utility: mm â†’ CSS-Pixel (AnnÃ¤herung).
  // Hinweis: "echte" mm sind im mobilen Browser nicht exakt. Deshalb geben wir
  // einen praktischen Regler + sinnvollen Default. Wir begrenzen den Kreis auf die Stage-Breite.
  const ring = document.getElementById('ring');
  const stage = document.getElementById('stage');
  const statusEl = document.getElementById('status');
  const sizeInput = document.getElementById('size');
  const mmOut = document.getElementById('mmOut');
  const btn = document.getElementById('btn');

  const state = {
    listening: false,
    isGreen: false,
    cooldownUntil: 0,
    ctx: null,
    analyser: null,
    data: null,
  };

  function mmToPx(mm){
    // sehr grobe Faustformel: ~3.78 px pro mm (96dpi)
    // Auf Phones variiert das. Nutzer kann nachregeln.
    return mm * 3.78;
  }

  function layoutRing(){
    const mm = parseInt(sizeInput.value, 10);
    const px = Math.min(mmToPx(mm), stage.clientWidth * 0.9);
    ring.style.width = px + 'px';
    ring.style.height = px + 'px';
    mmOut.textContent = mm;
  }
  window.addEventListener('resize', layoutRing, {passive:true});
  sizeInput.addEventListener('input', layoutRing, {passive:true});
  layoutRing();

  // Audio-Setup (wie im ersten PoC, leicht verbessert)
  async function startListening(){
    if (state.listening) return;
    statusEl.textContent = 'Starte Mikrofonâ€¦';
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 2048;
      src.connect(analyser);

      state.ctx = ctx;
      state.analyser = analyser;
      state.data = new Uint8Array(analyser.fftSize);
      state.listening = true;
      statusEl.textContent = 'Bereit: Stell dein Glas ab!';
      btn.textContent = 'LÃ¤uft';
      btn.classList.add('ok');
      tick();
    }catch(e){
      statusEl.textContent = 'Mikrofon nicht verfÃ¼gbar. Erlaube Zugriff & tippe Start nochmal.';
      btn.textContent = 'Start';
      btn.classList.remove('ok');
      state.listening = false;
    }
  }

  function setDetected(on){
    if (on === state.isGreen) return;
    state.isGreen = on;
    document.body.classList.toggle('detected', on);
    document.body.classList.add('flash');
    setTimeout(()=>document.body.classList.remove('flash'), 420);
    statusEl.textContent = on ? 'âœ… Glas erkannt!' : 'Bereit: Stell dein Glas ab!';
  }

  function tick(){
    if (!state.listening) return;
    state.analyser.getByteTimeDomainData(state.data);

    // einfache Peak-Erkennung
    let peak = 0;
    for (let i = 0; i < state.data.length; i++){
      const v = Math.abs(state.data[i] - 128);
      if (v > peak) peak = v;
    }

    const now = performance.now();
    const THRESHOLD = 110;     // ggf. anpassen
    const COOLDOWN_MS = 1100;

    if (peak > THRESHOLD && now > state.cooldownUntil){
      // toggle Zustand
      setDetected(!state.isGreen);
      state.cooldownUntil = now + COOLDOWN_MS;
      // kleines visuelles Feedback am Ring
      ring.animate(
        [{filter:'brightness(1.6) saturate(1.2)'},{filter:'brightness(1) saturate(1)'}],
        {duration:380, easing:'ease-out'}
      );
    }
    requestAnimationFrame(tick);
  }

  // iOS braucht User-Geste
  btn.addEventListener('click', startListening, { once: false });
</script>
</body>
</html>

