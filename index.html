<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Glass Target â€“ PoC (besseres UI)</title>
<style>
  :root{ --bg:#b40000; --ok:#0a7a0a; --ring:#ffffffcc; --text:#fff; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{display:flex;justify-content:center;padding:.75rem 1rem}
  .cta{padding:.6rem 1rem;border-radius:999px;background:#00000040;backdrop-filter:blur(6px)}
  main{flex:1;display:grid;place-items:center;padding:16px}
  .stage{position:relative;display:grid;place-items:center;width:100%;height:100%;max-width:720px;overflow:visible}
  .hint{position:absolute;top:8%;left:50%;transform:translateX(-50%);text-align:center;max-width:86%}
  .hint .title{font-size:clamp(18px,4.5vw,28px)}
  .hint .sub{font-weight:500;opacity:.85;margin-top:.35rem}
  .target{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;overflow:visible}
  .ringWrap{position:relative;display:grid;place-items:center;overflow:visible} /* kein clamp mehr */
  .arrow{position:absolute;top:-120px;left:50%;transform:translateX(-50%);
    width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:16px solid var(--ring);
    filter:drop-shadow(0 2px 4px #00000050);animation:bounce 1.2s ease-in-out infinite;}
  @keyframes bounce{0%,100%{transform:translate(-50%,0)}50%{transform:translate(-50%,6px)}}
  .status{position:absolute;bottom:18%;left:50%;transform:translateX(-50%);
    padding:.6rem 1rem;border-radius:12px;background:#00000033;backdrop-filter:blur(6px);font-weight:700;letter-spacing:.2px}
  /* Controls jetzt vertikal gestapelt */
  .controls{
    position:absolute;bottom:2%;left:50%;transform:translateX(-50%);
    width:min(92vw,560px);
    display:flex;flex-direction:column;gap:.55rem;
    background:#00000033;padding:.75rem;border-radius:14px;backdrop-filter:blur(8px);font-weight:600
  }
  .controlRow{display:flex;align-items:center;gap:.75rem}
  .controlRow label{min-width:max(120px,30%);opacity:.95}
  .controlRow .value{margin-left:auto;opacity:.9;background:#ffffff22;padding:.15rem .5rem;border-radius:.5rem}
  .controlRow input[type="range"]{flex:1}
  .go{align-self:flex-start;padding:.5rem .9rem;border-radius:.7rem;background:#ffffff22;border:1px solid #ffffff45;color:#fff}
  .ok{background:#ffffff33}
  .detected body, .detected{background:var(--ok)}
  .flash{animation:flash .4s ease-out}
  @keyframes flash{0%{filter:brightness(1.6)}100%{filter:brightness(1)}}
  /* Countdown + Ring */
  .countText{position:absolute;inset:0;display:grid;place-items:center;font-size:clamp(22px,8vw,44px);font-weight:800;text-shadow:0 2px 6px #0007}
  .label{position:absolute;top:60%;left:50%;transform:translateX(-50%);font-size:clamp(12px,3.6vw,16px);opacity:.95}
  .pulse{animation:pulse 1.6s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.04);opacity:.96}}
</style>
</head>
<body>
<div class="wrap">
  <header><div class="cta">ðŸ‘‰ <strong>Stell dein Glas hier ab</strong> â€“ tippe <em>Start</em>, dann hÃ¶rbar absetzen.</div></header>

  <main>
    <div class="stage" id="stage">
      <div class="hint">
        <div class="title">ZIELKREIS</div>
        <div class="sub">Platziere den Glasboden im Kreis. Beim Abstellen: Sound & Countdown.</div>
      </div>

      <div class="target">
        <div class="ringWrap" id="ringWrap" aria-label="Zielkreis">
          <div class="arrow" aria-hidden="true"></div>
          <svg id="ringSvg" width="260" height="260" viewBox="0 0 260 260" class="pulse" aria-hidden="true">
            <circle id="track" cx="130" cy="130" r="110" fill="none" stroke="#ffffff26" stroke-width="14" stroke-dasharray="8 10"/>
            <circle id="progress" cx="130" cy="130" r="110" fill="none" stroke="white" stroke-opacity=".9" stroke-width="10"
              stroke-linecap="round" transform="rotate(-90 130 130)" stroke-dasharray="690" stroke-dashoffset="690"/>
          </svg>
          <div class="countText"><span id="countNum"> </span></div>
          <div class="label" id="label">Stell dein Glas ab</div>
        </div>
      </div>

      <div class="status" id="status">Warte auf Startâ€¦</div>

      <div class="controls">
        <button id="btn" class="go">Start</button>

        <div class="controlRow">
          <label for="size">Durchmesser (Glasboden)</label>
          <input id="size" type="range" min="45" max="90" value="65" step="1" />
          <span class="value"><span id="mmOut">65</span> mm</span>
        </div>

        <div class="controlRow">
          <label for="secs">Countdown</label>
          <input id="secs" type="range" min="3" max="15" value="5" step="1" />
          <span class="value"><span id="sOut">5</span> s</span>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  const ringWrap = document.getElementById('ringWrap');
  const ringSvg  = document.getElementById('ringSvg');
  const progress = document.getElementById('progress');
  const track    = document.getElementById('track');
  const countNum = document.getElementById('countNum');
  const label    = document.getElementById('label');
  const stage    = document.getElementById('stage');
  const statusEl = document.getElementById('status');
  const sizeInput= document.getElementById('size');
  const secsInput= document.getElementById('secs');
  const mmOut    = document.getElementById('mmOut');
  const sOut     = document.getElementById('sOut');
  const btn      = document.getElementById('btn');

  const state = {
    listening:false,
    isGreen:false,
    cooldownUntil:0,
    ctx:null, analyser:null, data:null,
    countdownActive:false, startTime:0, durationMs:5000, raf:0,
  };

  // mm -> px; Nutzer kann feinjustieren
  function mmToPx(mm){ return mm * 3.78; }

  function layoutRing(){
    // KreisgrÃ¶ÃŸe: min(Breite,HÃ¶he) nutzen, aber vom Nutzer-Durchmesser Ã¼bersteuern
    const mm = parseInt(sizeInput.value,10);
    mmOut.textContent = mm;

    // Ziel: reale mm-GrÃ¶ÃŸe, aber nicht kleiner als 45mm, nicht grÃ¶ÃŸer als Bildschirmkante
    const desiredPx = mmToPx(mm);

    // maximal mÃ¶gliche FlÃ¤che: 80% der kleineren Kante der Stage (mehr â€žLuftâ€œ drumherum)
    const maxPx = Math.min(stage.clientWidth, stage.clientHeight) * 0.8;

    // finaler Kreis
    const px = Math.min(desiredPx, maxPx);

    ringWrap.style.width = px + 'px';
    ringWrap.style.height = px + 'px';

    // SVG anpassen
    ringSvg.setAttribute('width', px);
    ringSvg.setAttribute('height', px);

    const r = Math.max(10, (px/2) - Math.max(12, px*0.08));
    const c = 2 * Math.PI * r;

    [track, progress].forEach(el=>{
      el.setAttribute('cx', px/2);
      el.setAttribute('cy', px/2);
      el.setAttribute('r', r);
    });
    // dynamische Strichbreiten skaliert zur GrÃ¶ÃŸe
    track.setAttribute('stroke-width', Math.max(8, px*0.055));
    progress.setAttribute('stroke-width', Math.max(6, px*0.04));

    progress.setAttribute('stroke-dasharray', c.toFixed(1));
    progress.setAttribute('stroke-dashoffset', c.toFixed(1));
  }
  window.addEventListener('resize', layoutRing, {passive:true});
  sizeInput.addEventListener('input', layoutRing, {passive:true});
  layoutRing();

  secsInput.addEventListener('input', ()=>{
    sOut.textContent = secsInput.value;
    state.durationMs = parseInt(secsInput.value,10)*1000;
  });

  async function startListening(){
    if (state.listening) return;
    statusEl.textContent = 'Starte Mikrofonâ€¦';
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const src = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 2048;
      src.connect(analyser);
      state.ctx = ctx; state.analyser = analyser;
      state.data = new Uint8Array(analyser.fftSize);
      state.listening = true;
      statusEl.textContent = 'Bereit: Stell dein Glas ab!';
      btn.textContent = 'LÃ¤uft'; btn.classList.add('ok');
      tick();
    }catch(e){
      statusEl.textContent = 'Mikrofon nicht verfÃ¼gbar. Erlaube Zugriff & tippe Start.';
      btn.textContent = 'Start'; btn.classList.remove('ok');
      state.listening = false;
    }
  }

  function playPing(){
    if (!state.ctx) return;
    const o = state.ctx.createOscillator();
    const g = state.ctx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(880, state.ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(1320, state.ctx.currentTime + 0.12);
    g.gain.setValueAtTime(0.001, state.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.25, state.ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, state.ctx.currentTime + 0.22);
    o.connect(g).connect(state.ctx.destination);
    o.start(); o.stop(state.ctx.currentTime + 0.24);
  }

  function successChime(){
    if (!state.ctx) return;
    const times = [0, 0.08, 0.16];
    const freqs = [660, 880, 1320];
    times.forEach((dt,i)=>{
      const o = state.ctx.createOscillator();
      const g = state.ctx.createGain();
      o.type='sine'; o.frequency.value = freqs[i];
      g.gain.setValueAtTime(0.0001, state.ctx.currentTime + dt);
      g.gain.exponentialRampToValueAtTime(0.22, state.ctx.currentTime + dt + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, state.ctx.currentTime + dt + 0.18);
      o.connect(g).connect(state.ctx.destination);
      o.start(state.ctx.currentTime + dt);
      o.stop(state.ctx.currentTime + dt + 0.2);
    });
  }

  function setDetected(on){
    if (on === state.isGreen) return;
    state.isGreen = on;
    document.body.classList.toggle('detected', on);
    document.body.classList.add('flash');
    setTimeout(()=>document.body.classList.remove('flash'), 420);
    statusEl.textContent = on ? 'âœ… Glas erkannt!' : 'Bereit: Stell dein Glas ab!';
    label.textContent = on ? 'Countdown lÃ¤uftâ€¦' : 'Stell dein Glas ab';

    if (on){
      playPing();
      startCountdown();
    } else {
      stopCountdown(true);
    }
  }

  function startCountdown(){
    if (state.countdownActive) return;
    state.countdownActive = true;
    state.startTime = performance.now();
    animateCountdown();
  }
  function stopCountdown(resetRing){
    state.countdownActive = false;
    cancelAnimationFrame(state.raf);
    if (resetRing){
      const len = parseFloat(progress.getAttribute('stroke-dasharray'))||690;
      progress.setAttribute('stroke-dashoffset', len);
      countNum.textContent = '';
      ringSvg.classList.add('pulse');
    }
  }

  function animateCountdown(){
    const now = performance.now();
    const t = Math.min(1, (now - state.startTime)/state.durationMs);
    const len = parseFloat(progress.getAttribute('stroke-dasharray'))||690;
    progress.setAttribute('stroke-dashoffset', (len * (1 - t)).toFixed(1));
    ringSvg.classList.remove('pulse');

    const remaining = Math.max(0, Math.ceil((state.durationMs - (now - state.startTime))/1000));
    countNum.textContent = remaining > 0 ? remaining : '0';

    if (t < 1 && state.countdownActive){
      state.raf = requestAnimationFrame(animateCountdown);
    } else if (t >= 1){
      successChime();
      label.textContent = 'Fertig!';
      setTimeout(()=>{ setDetected(false); }, 800);
    }
  }

  function tick(){
    if (!state.listening) return;
    state.analyser.getByteTimeDomainData(state.data);
    let peak = 0;
    for (let i=0;i<state.data.length;i++){
      const v = Math.abs(state.data[i]-128);
      if (v > peak) peak = v;
    }
    const now = performance.now();
    const THRESHOLD = 110;    // ggf. anpassen
    const COOLDOWN_MS = 1100;

    if (peak > THRESHOLD && now > state.cooldownUntil){
      setDetected(!state.isGreen);
      state.cooldownUntil = now + COOLDOWN_MS;
      ringWrap.animate(
        [{filter:'brightness(1.6) saturate(1.2)'},{filter:'brightness(1) saturate(1)'}],
        {duration:380,easing:'ease-out'}
      );
    }
    requestAnimationFrame(tick);
  }

  btn.addEventListener('click', startListening);
</script>
</body>
</html>

